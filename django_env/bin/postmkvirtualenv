# Check to see if the user wants to install a Django environment
echo -n "Is this a Django-enviroment your creating (y/n)? [Default: y] "
read -e IS_DJANGO_ENV

if [ -z "$IS_DJANGO_ENV" ]; then
    IS_DJANGO_ENV="y"
fi
if [ $IS_DJANGO_ENV == "n" ]; then
    exit 0
fi

# setup the Django project directory and ask question about the Django project
PROJECT_NAME=`basename $VIRTUAL_ENV`

CONFIG_PATH="$PROJECT_NAME.config"
echo -n "Enter the python path to the config directory (i.e. Where your settings.py, manage.py and urls.py will go). Use a period (.) if you want the config files in your current project root. [Default: $CONFIG_PATH] "
read -e CONFIG_PATH_INPUT
if [ -n "$CONFIG_PATH_INPUT" ]; then
    CONFIG_PATH=$CONFIG_PATH_INPUT
fi

echo -n "Development server address? [Default: 127.0.0.1] "
read -e SERVER_ADDR_INPUT

echo -n "Development server address? [Default: 8000] "
read -e SERVER_PORT_INPUT

echo -n "Create a blank Fabric fabfile in your project (y/n)? [Default: y] "
read -e CREATE_FABFILE_INPUT
CREATE_FABFILE="y"
if [ -n "$CREATE_FABFILE_INPUT" ]; then
    CREATE_FABFILE=$CREATE_FABFILE_INPUT
fi

# install Django
pip install django

# Setup the Django project
DJANGO_ENV_PROJECT_DIR=`pwd`
django-admin.py startproject temp

SETTINGS_MODULE="$PROJECT_NAME\.config\.settings"
FABFILE_LOCATION="$DJANGO_ENV_PROJECT_DIR/$PROJECT_NAME/config/fabfile.py"
SETTINGS_PATH="$DJANGO_ENV_PROJECT_DIR/$PROJECT_NAME/config/settings.py"
ROOT_URLCONF="$PROJECT_NAME\.config\.urls"
if [ "$CONFIG_PATH_INPUT" == "." ]; then
    FABFILE_LOCATION="`pwd`/fabfile.py"
    SETTINGS_PATH="`pwd`/settings.py"
    ROOT_URLCONF="urls"
    SETTINGS_MODULE="settings"
    mv temp/* `pwd`
    rm -rf temp
else
    SHELLPATH=`echo $CONFIG_PATH | perl -wpe "s/\./\//g"`
    FABFILE_LOCATION="$SHELLPATH/fabfile.py"
    SETTINGS_PATH="$SHELLPATH/settings.py"
    ROOT_URLCONF="$CONFIG_PATH.urls"
    SETTINGS_MODULE="$CONFIG_PATH.settings"
    mkdir -p $SHELLPATH
    cp temp/* $SHELLPATH/
    find . -type d -exec touch {}/__init__.py \;
    rm __init__.py
    rm -rf temp
fi


# Setup the django_env_settings.py
LOCAL_SETTINGS=`cat $WORKON_HOME/django_env/config/django_env_settings_template.txt`
LOCAL_SETTINGS_TARGET=$VIRTUAL_ENV/bin/django_env_settings.py
echo "$LOCAL_SETTINGS" > $LOCAL_SETTINGS_TARGET

perl -i -wpe "s|{{ PROJECT_DIR }}|$DJANGO_ENV_PROJECT_DIR|g" $LOCAL_SETTINGS_TARGET
perl -i -wpe "s/{{ SETTINGS_MODULE }}/$SETTINGS_MODULE/g" $LOCAL_SETTINGS_TARGET
if [ -n "$SERVER_ADDR_INPUT" ]; then
    perl -i -wpe "s/127\.0\.0\.1/$SERVER_ADDR_INPUT/g" $LOCAL_SETTINGS_TARGET
    perl -i -wpe "s/# DJANGO_ENV_SERVER_ADDR/DJANGO_ENV_SERVER_ADDR  /g" $LOCAL_SETTINGS_TARGET
fi
if [ -n "$SERVER_PORT_INPUT" ]; then
    perl -i -wpe "s/8000/$SERVER_PORT_INPUT/g" $LOCAL_SETTINGS_TARGET
    perl -i -wpe "s/# DJANGO_ENV_SERVER_PORT/DJANGO_ENV_SERVER_PORT  /g" $LOCAL_SETTINGS_TARGET
fi
perl -i -wpe "s|{{ FABFILE }}|$FABFILE_LOCATION|g" $LOCAL_SETTINGS_TARGET
if [ "$CREATE_FABFILE" == "y" ]; then
    FABFILE=`cat $WORKON_HOME/django_env/config/empty_fabfile.txt`
    echo "$FABFILE" > $FABFILE_LOCATION
fi


# symlink all bin files
ln -s $WORKON_HOME/django_env/bin/runserver $VIRTUAL_ENV/bin/runserver
ln -s $WORKON_HOME/django_env/utils/get_django_env_settings.py $VIRTUAL_ENV/bin/get_django_env_settings.py


# add the postactivate and postdeactivate hooks
echo '

source $WORKON_HOME/django_env/bin/postactivate

' >> "$VIRTUAL_ENV/bin/postactivate"
echo '

source $WORKON_HOME/django_env/bin/postdeactivate

' >> "$VIRTUAL_ENV/bin/postdeactivate"

# fix the ROOT_URLCONF setting
perl -i -wpe "s/temp\.urls/$ROOT_URLCONF/g" $SETTINGS_PATH

# add all paths to the PYTHONPATH
add2virtualenv $DJANGO_ENV_PROJECT_DIR

# source the Django-environment postactivate script
source "$WORKON_HOME/django_env/bin/postactivate"
